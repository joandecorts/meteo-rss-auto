name: Update Meteo RSS

on:
  # 1. DISPARAT MANUALMENT (des de GitHub)
  workflow_dispatch:
    inputs:
      source:
        description: 'Origen de la trigger'
        required: false
        default: 'github_manual'
        type: string

  # 2. DISPARAT DES DE CRON-JOB.ORG
  repository_dispatch:
    types: [trigger_update]

  # 3. TODO AUTOM√ÄTIC A GITHUB
  schedule:
    - cron: "*/5 * * * *"      # üì° RSS cada 5 minuts
    - cron: "15,45 * * * *"    # üå§Ô∏è HTMLs a hores:15 i :45

# Variable per identificar l'origen de l'execuci√≥
env:
  WORKFLOW_SOURCE: ${{ github.event_name }}

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      # 1. DESCARREGA REPOSITORI (amb les dues branques)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: main  # Assegura que treballem des de main
      
      # 2. OBT√â INFORMACI√ì DE L'ORIGEN
      - name: Detect trigger source
        id: trigger-source
        run: |
          SOURCE="${{ github.event_name }}"
          SOURCE_DETAIL=""
          
          if [ "$SOURCE" = "repository_dispatch" ]; then
            SOURCE_DETAIL="${{ github.event.client_payload.source || 'cron-job.org' }}"
            echo "source=cron-job.org" >> $GITHUB_OUTPUT
            echo "triggered_by=joandecorts" >> $GITHUB_OUTPUT
            echo "source_detail=$SOURCE_DETAIL" >> $GITHUB_OUTPUT
          elif [ "$SOURCE" = "workflow_dispatch" ]; then
            echo "source=${{ github.event.inputs.source || 'github_manual' }}" >> $GITHUB_OUTPUT
            echo "triggered_by=${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "source_detail=manual" >> $GITHUB_OUTPUT
          else
            echo "source=github_schedule" >> $GITHUB_OUTPUT
            echo "triggered_by=github_actions" >> $GITHUB_OUTPUT
            echo "source_detail=${{ github.event.schedule }}" >> $GITHUB_OUTPUT
          fi
          
          echo "üîÑ Origen de l'execuci√≥: $SOURCE"
          echo "üìã Detalls: $(cat $GITHUB_OUTPUT)"
      
      # 3. CONFIGURA PYTHON
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # 4. INSTAL¬∑LA LLIBRERIES
      - name: Install dependencies
        run: pip install requests beautifulsoup4 pytz lxml
      
      # 5. EXECUTA ELS SCRIPTS
      - name: Run weather scripts
        run: |
          echo "üéØ Executant scripts Python..."
          echo "üìä Origen: ${{ steps.trigger-source.outputs.source }}"
          echo "üë§ Disparat per: ${{ steps.trigger-source.outputs.triggered_by }}"
          
          # Executa els scripts
          python daily_weather_scraper.py
          python generate_fullscreen_html.py
          python generate_meteo_rss.py
      
      # 6. VERIFICA RESULTATS
      - name: Verify generated files
        run: |
          echo "‚úÖ √öltima actualitzaci√≥: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "üéØ Origen: ${{ steps.trigger-source.outputs.source }}"
          echo "üë§ Trigger: ${{ steps.trigger-source.outputs.triggered_by }}"
          echo "üìÅ Arxius generats:"
          ls -la *.html *.rss 2>/dev/null || echo "No s'han generat arxius"
          
          # Verifica contingut RSS
          if [ -f "meteo.rss" ]; then
            echo "üì° RSS generat correctament"
            echo "üìè Mida: $(wc -l < meteo.rss) l√≠nies"
            echo "‚è∞ √öltima entrada:"
            grep -A 3 "<pubDate>" meteo.rss | head -4
          fi
      
      # 7. PUJA A GH-PAGES
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: false
          commit_message: |
            ü§ñ Actualitzaci√≥ autom√†tica
            - Origen: ${{ steps.trigger-source.outputs.source }}
            - Disparat per: ${{ steps.trigger-source.outputs.triggered_by }}
            - Data: $(date -u +'%Y-%m-%d %H:%M UTC')
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      
      # 8. REGISTRA L'EXECUCI√ì
      - name: Log execution
        if: always()
        run: |
          echo "üìã RESUM DE L'EXECUCI√ì"
          echo "======================"
          echo "Data: $(date)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Origen: ${{ steps.trigger-source.outputs.source }}"
          echo "Disparat per: ${{ steps.trigger-source.outputs.triggered_by }}"
          echo "SHA: ${{ github.sha }}"
          echo "Resultat: ${{ job.status }}"
