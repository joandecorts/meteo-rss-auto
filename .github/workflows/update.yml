name: Update Meteo RSS

on:
  # 1. DISPARAT MANUALMENT
  workflow_dispatch:
  
  # 2. TODO AUTOM√ÄTIC A GITHUB
  schedule:
    - cron: "*/5 * * * *"      # üì° RSS cada 5 minuts
    - cron: "15,45 * * * *"    # üå§Ô∏è HTMLs a hores:15 i :45

  # 3. DISPARAT DES DE CRON-JOB.ORG
  repository_dispatch:
    types: [trigger_update]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      # 1. DESCARREGA REPOSITORI
      - uses: actions/checkout@v3
      
      # 2. IDENTIFICA ORIGEN DEL TRIGGER
      - name: Identificar origen de l'execuci√≥
        run: |
          echo "üîç ANALITZANT ORIGEN DE L'EXECUCI√ì"
          echo "====================================="
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üöÄ AQUESTA EXECUCI√ì VE DE CRON-JOB.ORG"
            echo "üë§ Disparat per: joandecorts"
            echo "üìå Event type: ${{ github.event.action || 'trigger_update' }}"
            echo "‚è∞ Hora del trigger: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "üíæ Client payload: ${{ toJson(github.event.client_payload) || 'No payload' }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üñ±Ô∏è AQUESTA EXECUCI√ì VE DE TRIGGER MANUAL (GitHub)"
            echo "üë§ Disparat per: ${{ github.actor }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "‚è∞ AQUESTA EXECUCI√ì VE DE PROGRAMACI√ì INTERNA (GitHub Actions)"
            echo "üìÖ Cron: ${{ github.event.schedule || '15,45 * * * *' }}"
          else
            echo "‚ùì ORIGEN DESCONEGUT: ${{ github.event_name }}"
          fi
          
          echo ""
          echo "üìä RESUM DEL TRIGGER:"
          echo "--------------------"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "SHA: ${{ github.sha }}"
      
      # 3. CONFIGURA PYTHON
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # 4. INSTAL¬∑LA LLIBRERIES
      - run: pip install requests beautifulsoup4 pytz lxml
      
      # 5. EXECUTA ELS SCRIPTS (tot cada vegada)
      - run: python daily_weather_scraper.py
      - run: python generate_fullscreen_html.py
      - run: python generate_meteo_rss.py
      
      # 6. VERIFICA (opcional)
      - name: Mostra arxius generats
        run: |
          echo "‚úÖ √öltima actualitzaci√≥: $(date '+%H:%M:%S')"
          
          # Afegim missatge espec√≠fic si ve de cron-job.org
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üéØ ORIGEN CONFIRMAT: cron-job.org via joandecorts"
          fi
          
          echo "üìÅ Arxius:"
          ls -la *.html *.rss 2>/dev/null || echo "No s'han generat arxius"
      
      # 7. PUJA A GH-PAGES
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .                # Puja TOT
          publish_branch: gh-pages      # A la branca gh-pages
          keep_files: false             # Neteja l'anterior
          
          # Missatge de commit m√©s informatiu
          commit_message: |
            ü§ñ Actualitzaci√≥ autom√†tica
            
            Origen: ${{ github.event_name }}
            ${{ github.event_name == 'repository_dispatch' && 'Disparat per: joandecorts (cron-job.org)' || github.event_name == 'workflow_dispatch' && format('Disparat manualment per: {0}', github.actor) || 'Programaci√≥ interna GitHub' }}
            Data: $(date -u +'%Y-%m-%d %H:%M UTC')
            
            SHA: ${{ github.sha }}
          
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      
      # 8. MISSATGE FINAL DE CONFIRMACI√ì
      - name: Confirmaci√≥ final
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "‚úÖ EXECUCI√ì COMPLETADA"
          echo "========================================"
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "üåê ORIGEN: cron-job.org"
            echo "üë§ DISPARADOR: joandecorts"
            echo "üéØ ESTAT: Trigger extern rebut correctament"
          else
            echo "üåê ORIGEN: ${{ github.event_name }}"
          fi
          
          echo "üïê FINALITZAT A: $(date '+%H:%M:%S')"
          echo "üìä RUN ID: ${{ github.run_id }}"
          echo "========================================"
