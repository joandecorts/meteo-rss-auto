name: Update Meteo RSS

on:
  # 1. DISPARAT MANUALMENT
  workflow_dispatch:
  
  # 2. TODO AUTOMÃ€TIC A GITHUB (DESACTIVAT PER EVITAR CONFLICTES AMB CRON-JOB.ORG)
  # schedule:
  #   - cron: "*/5 * * * *"      # ğŸ“¡ RSS cada 5 minuts (COMENTAT)
  #   - cron: "15,45 * * * *"    # ğŸŒ¤ï¸ HTMLs a hores:15 i :45 (COMENTAT)

  # 3. DISPARAT DES DE CRON-JOB.ORG (ÃšNICA AUTOMATITZACIÃ“ ACTIVA)
  repository_dispatch:
    types: [trigger_update]

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      # 1. DESCARREGA REPOSITORI
      - uses: actions/checkout@v3
      
      # 2. IDENTIFICA ORIGEN DEL TRIGGER
      - name: Identificar origen de l'execuciÃ³
        run: |
          echo "ğŸ” ANALITZANT ORIGEN DE L'EXECUCIÃ“"
          echo "====================================="
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸš€ AQUESTA EXECUCIÃ“ VE DE CRON-JOB.ORG"
            echo "ğŸ‘¤ Disparat per: joandecorts"
            echo "ğŸ“Œ Event type: ${{ github.event.action || 'trigger_update' }}"
            echo "â° Hora del trigger: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo "ğŸ’¾ Client payload: ${{ toJson(github.event.client_payload) || 'No payload' }}"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ–±ï¸ AQUESTA EXECUCIÃ“ VE DE TRIGGER MANUAL (GitHub)"
            echo "ğŸ‘¤ Disparat per: ${{ github.actor }}"
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "â° AQUESTA EXECUCIÃ“ VE DE PROGRAMACIÃ“ INTERNA (GitHub Actions)"
            echo "ğŸ“… Cron: ${{ github.event.schedule || '15,45 * * * *' }}"
          else
            echo "â“ ORIGEN DESCONEGUT: ${{ github.event_name }}"
          fi
          
          echo ""
          echo "ğŸ“Š RESUM DEL TRIGGER:"
          echo "--------------------"
          echo "Event: ${{ github.event_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "SHA: ${{ github.sha }}"
      
      # 3. CONFIGURA PYTHON
      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      # 4. INSTALÂ·LA LLIBRERIES
      - run: pip install requests beautifulsoup4 pytz lxml
      
      # 5. EXECUTA ELS SCRIPTS (tot cada vegada)
      - run: python daily_weather_scraper.py
      - run: python generate_fullscreen_html.py
      - run: python generate_meteo_rss.py
      
      # 6. VERIFICA (opcional)
      - name: Mostra arxius generats
        run: |
          echo "âœ… Ãšltima actualitzaciÃ³: $(date '+%H:%M:%S')"
          
          # Afegim missatge especÃ­fic si ve de cron-job.org
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸ¯ ORIGEN CONFIRMAT: cron-job.org via joandecorts"
          fi
          
          echo "ğŸ“ Arxius:"
          ls -la *.html *.rss 2>/dev/null || echo "No s'han generat arxius"
      
      # 7. PUJA A GH-PAGES
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.meteo-rss-auto-renewed }}
          publish_dir: .                # Puja TOT
          publish_branch: gh-pages      # A la branca gh-pages
          keep_files: false             # Neteja l'anterior
          
          # Missatge de commit mÃ©s informatiu
          commit_message: |
            ğŸ¤– ActualitzaciÃ³ automÃ tica
            
            Origen: ${{ github.event_name }}
            ${{ github.event_name == 'repository_dispatch' && 'Disparat per: joandecorts (cron-job.org)' || github.event_name == 'workflow_dispatch' && format('Disparat manualment per: {0}', github.actor) || 'ProgramaciÃ³ interna GitHub' }}
            Data: $(date -u +'%Y-%m-%d %H:%M UTC')
            
            SHA: ${{ github.sha }}
          
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
      
      # 8. MISSATGE FINAL DE CONFIRMACIÃ“
      - name: ConfirmaciÃ³ final
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "âœ… EXECUCIÃ“ COMPLETADA"
          echo "========================================"
          
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸŒ ORIGEN: cron-job.org"
            echo "ğŸ‘¤ DISPARADOR: joandecorts"
            echo "ğŸ¯ ESTAT: Trigger extern rebut correctament"
          else
            echo "ğŸŒ ORIGEN: ${{ github.event_name }}"
          fi
          
          echo "ğŸ• FINALITZAT A: $(date '+%H:%M:%S')"
          echo "ğŸ“Š RUN ID: ${{ github.run_id }}"
          echo "========================================"
