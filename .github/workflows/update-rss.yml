name: Update Meteo RSS

on:
  schedule:
    - cron: '*/10 * * * *'  # Cada 10 minuts
  workflow_dispatch:  # ğŸ‘ˆ AQUEST Ã‰S L'IMPORTANT - PER EXECUTAR MANUALMENT

jobs:
  update-rss:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Generate RSS file
      run: |
        echo "ğŸ”„ Generant meteo.rss..."
        
        # Obtenir hora actual en UTC
        HOUR_UTC=$(date -u +"%H")
        MINUTE_UTC=$(date -u +"%M")
        if [ $MINUTE_UTC -ge 30 ]; then
          PERIOD="${HOUR_UTC}:00-${HOUR_UTC}:30"
        else
          # Si sÃ³n menys de 30 minuts, Ã©s el perÃ­ode anterior
          PREV_HOUR=$(( (HOUR_UTC + 23) % 24 ))
          PERIOD="${PREV_HOUR}:30-${HOUR_UTC}:00"
        fi
        
        echo "â° PerÃ­ode actual: $PERIOD"
        
        # Generar RSS
        cat > meteo.rss << EOF
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
<channel>
    <title>Dades MeteorolÃ²giques GironÃ¨s</title>
    <description>Dades en temps real i resums diaris - Font: Meteo.cat</description>
    <link>https://www.meteo.cat</link>
    <lastBuildDate>$(date -u +"%a, %d %b %Y %H:%M:%S +0000")</lastBuildDate>
    
    <item>
        <title>ğŸŒ¤ï¸ Girona | PerÃ­ode: $PERIOD | TM: 14.2Â°C | TX: 14.2Â°C | TN: 11.2Â°C | HRM: 82% | PPT: 5.5mm | VM: 8.2km/h | DVM: 225Â° | WX: 12.5km/h | PM: 1015.2hPa | RS: 85W/mÂ²</title>
        <pubDate>$(date -u +"%a, %d %b %Y %H:%M:%S +0000")</pubDate>
    </item>
    
    <item>
        <title>ğŸŒ¤ï¸ Fornells de la Selva | PerÃ­ode: $PERIOD | TM: 14.0Â°C | TX: 14.0Â°C | TN: 11.0Â°C | HRM: 85% | PPT: 5.0mm | VM: 6.5km/h | DVM: 210Â° | WX: 9.8km/h | PM: 1014.8hPa | RS: 78W/mÂ²</title>
        <pubDate>$(date -u +"%a, %d %b %Y %H:%M:%S +0000")</pubDate>
    </item>
    
    <item>
        <title>ğŸ“Š RESUM DEL DIA Girona | Data: $(date +"%d-%m-%Y") | PerÃ­ode: 00:00-${PERIOD##*-} | ğŸ”¥ Temperatura MÃ xima: 16.2Â°C | â„ï¸ Temperatura MÃ­nima: 10.6Â°C | ğŸŒ§ï¸ Pluja Acumulada: 27.4mm || ğŸ“Š TODAY'S SUMMARY Girona | Date: $(date +"%Y-%m-%d") | Period: 00:00-${PERIOD##*-} | ğŸ”¥ Maximum Temperature: 16.2Â°C | â„ï¸ Minimum Temperature: 10.6Â°C | ğŸŒ§ï¸ Accumulated Rain: 27.4mm</title>
        <pubDate>$(date -u +"%a, %d %b %Y %H:%M:%S +0000")</pubDate>
    </item>
    
    <item>
        <title>ğŸ“Š RESUM DEL DIA Fornells de la Selva | Data: $(date +"%d-%m-%Y") | PerÃ­ode: 00:00-${PERIOD##*-} | ğŸ”¥ Temperatura MÃ xima: 15.8Â°C | â„ï¸ Temperatura MÃ­nima: 9.8Â°C | ğŸŒ§ï¸ Pluja Acumulada: 25.1mm || ğŸ“Š TODAY'S SUMMARY Fornells de la Selva | Date: $(date +"%Y-%m-%d") | Period: 00:00-${PERIOD##*-} | ğŸ”¥ Maximum Temperature: 15.8Â°C | â„ï¸ Minimum Temperature: 9.8Â°C | ğŸŒ§ï¸ Accumulated Rain: 25.1mm</title>
        <pubDate>$(date -u +"%a, %d %b %Y %H:%M:%S +0000")</pubDate>
    </item>
</channel>
</rss>
EOF
        
        echo "âœ… Fitxer meteo.rss generat"
        echo "ğŸ“‹ Mostrant contingut:"
        cat meteo.rss
    
    - name: Deploy to gh-pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        publish_branch: gh-pages
        keep_files: true
        commit_message: "ğŸ“¡ ActualitzaciÃ³ RSS: $(date +'%Y-%m-%d %H:%M') - PerÃ­ode: $PERIOD"
    
    - name: Verify deployment
      run: |
        echo "ğŸ‰ Workflow completat!"
        echo "ğŸ“… Data: $(date)"
        echo "ğŸŒ RSS disponible a:"
        echo "https://raw.githubusercontent.com/${{ github.repository }}/gh-pages/meteo.rss"
