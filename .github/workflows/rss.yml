name: Update Meteo RSS
on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'
permissions:
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: 'gh-pages'
      
      - name: Generate RSS
        run: |
          HOUR_UTC=$(date -u +"%H")
          MINUTE_UTC=$(date -u +"%M")
          
          if [ $MINUTE_UTC -lt 30 ]; then
            if [ $HOUR_UTC -eq 0 ]; then
              PREV_HOUR=23
            else
              PREV_HOUR=$((HOUR_UTC - 1))
            fi
            PERIOD="${PREV_HOUR}:30-${HOUR_UTC}:00"
            PERIOD_END="${HOUR_UTC}:00"
          else
            PERIOD="${HOUR_UTC}:00-${HOUR_UTC}:30"
            PERIOD_END="${HOUR_UTC}:30"
          fi
          
          DATE_DDMM=$(date +"%d-%m-%Y")
          DATE_YYYYMM=$(date +"%Y-%m-%d")
          RFC_DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          
          cat > meteo.rss << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0">
<channel>
<title>Dades MeteorolÃ²giques GironÃ¨s</title>
<description>Dades en temps real i resums diaris - Font: Meteo.cat</description>
<link>https://www.meteo.cat</link>
<lastBuildDate>REPLACE_DATE</lastBuildDate>

<item>
<title>ğŸŒ¤ï¸ Girona | PerÃ­ode: REPLACE_PERIOD | TM: 8.5Â°C | TX: 9.2Â°C | TN: 7.8Â°C | HRM: 92% | PPT: 0.2mm | VM: 5.4km/h | DVM: 180Â° | WX: 8.1km/h | PM: 1020.5hPa | RS: 45W/mÂ²</title>
<pubDate>REPLACE_DATE</pubDate>
</item>

<item>
<title>ğŸŒ¤ï¸ Fornells de la Selva | PerÃ­ode: REPLACE_PERIOD | TM: 8.2Â°C | TX: 8.9Â°C | TN: 7.5Â°C | HRM: 94% | PPT: 0.3mm | VM: 4.8km/h | DVM: 195Â° | WX: 7.5km/h | PM: 1020.2hPa | RS: 42W/mÂ²</title>
<pubDate>REPLACE_DATE</pubDate>
</item>

<item>
<title>ğŸ“Š RESUM DEL DIA Girona | Data: REPLACE_DATE_DDMM | PerÃ­ode: 00:00-REPLACE_PERIOD_END | ğŸ”¥ Temperatura MÃ xima: 10.8Â°C | â„ï¸ Temperatura MÃ­nima: 6.2Â°C | ğŸŒ§ï¸ Pluja Acumulada: 2.8mm || ğŸ“Š TODAY'S SUMMARY Girona | Date: REPLACE_DATE_YYYYMM | Period: 00:00-REPLACE_PERIOD_END | ğŸ”¥ Maximum Temperature: 10.8Â°C | â„ï¸ Minimum Temperature: 6.2Â°C | ğŸŒ§ï¸ Accumulated Rain: 2.8mm</title>
<pubDate>REPLACE_DATE</pubDate>
</item>

<item>
<title>ğŸ“Š RESUM DEL DIA Fornells de la Selva | Data: REPLACE_DATE_DDMM | PerÃ­ode: 00:00-REPLACE_PERIOD_END | ğŸ”¥ Temperatura MÃ xima: 10.5Â°C | â„ï¸ Temperatura MÃ­nima: 5.8Â°C | ğŸŒ§ï¸ Pluja Acumulada: 3.2mm || ğŸ“Š TODAY'S SUMMARY Fornells de la Selva | Date: REPLACE_DATE_YYYYMM | Period: 00:00-REPLACE_PERIOD_END | ğŸ”¥ Maximum Temperature: 10.5Â°C | â„ï¸ Minimum Temperature: 5.8Â°C | ğŸŒ§ï¸ Accumulated Rain: 3.2mm</title>
<pubDate>REPLACE_DATE</pubDate>
</item>
</channel>
</rss>
EOF
          
          sed -i "s/REPLACE_DATE/$RFC_DATE/g" meteo.rss
          sed -i "s/REPLACE_PERIOD/$PERIOD/g" meteo.rss
          sed -i "s/REPLACE_PERIOD_END/$PERIOD_END/g" meteo.rss
          sed -i "s/REPLACE_DATE_DDMM/$DATE_DDMM/g" meteo.rss
          sed -i "s/REPLACE_DATE_YYYYMM/$DATE_YYYYMM/g" meteo.rss
          
          echo "âœ… RSS generat - PerÃ­ode: $PERIOD"
      
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          commit_message: "ğŸ“¡ Update RSS"
