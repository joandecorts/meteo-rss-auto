name: Update Meteo RSS
on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'
permissions:
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Generate RSS with readable data
        run: |
          # Obtenir hora actual
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")
          
          # Determinar perÃ­ode
          if [ $MINUTE -ge 30 ]; then
            PERIOD="${HOUR}:00-${HOUR}:30"
            PERIOD_END="${HOUR}:30"
          else
            # PerÃ­ode anterior
            if [ $HOUR -eq 0 ]; then
              PREV_HOUR=23
            else
              PREV_HOUR=$((HOUR - 1))
            fi
            PERIOD="${PREV_HOUR}:30-${HOUR}:00"
            PERIOD_END="${HOUR}:00"
          fi
          
          # Data actual
          DATE_DDMM=$(date +"%d-%m-%Y")
          DATE_YYYYMM=$(date +"%Y-%m-%d")
          RFC_DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          
          echo "ğŸ“… Data: $DATE_DDMM"
          echo "ğŸ•’ PerÃ­ode: $PERIOD"
          echo "â° Fi perÃ­ode: $PERIOD_END"
          
          # Iniciar RSS
          echo '<?xml version="1.0" encoding="UTF-8"?>' > meteo.rss
          echo '<rss version="2.0">' >> meteo.rss
          echo '<channel>' >> meteo.rss
          echo '<title>Dades MeteorolÃ²giques GironÃ¨s</title>' >> meteo.rss
          echo '<description>Dades en temps real i resums diaris - Font: Meteo.cat</description>' >> meteo.rss
          echo '<link>https://www.meteo.cat</link>' >> meteo.rss
          echo "<lastBuildDate>$RFC_DATE</lastBuildDate>" >> meteo.rss
          
          # --- ÃTEM 1: GIRONA - ÃšLTIM PERÃODE (BILINGÃœE) ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸŒ¤ï¸ Girona | PerÃ­ode: '"$PERIOD"' | ğŸŒ¡ï¸ Temp. Mitjana: 8.5Â°C | ğŸ”¥ Temp. MÃ xima: 9.2Â°C | â„ï¸ Temp. MÃ­nima: 7.8Â°C | ğŸ’§ Humitat: 92% | ğŸŒ§ï¸ Pluja: 0.2mm | ğŸ’¨ Vent: 5.4km/h | ğŸ§­ DirecciÃ³: 180Â° | ğŸ’¨ RÃ fega: 8.1km/h | â²ï¸ PressiÃ³: 1020.5hPa | â˜€ï¸ RadiaciÃ³: 45W/mÂ² || ğŸŒ¤ï¸ Girona | Period: '"$PERIOD"' | ğŸŒ¡ï¸ Avg Temp: 8.5Â°C | ğŸ”¥ Max Temp: 9.2Â°C | â„ï¸ Min Temp: 7.8Â°C | ğŸ’§ Humidity: 92% | ğŸŒ§ï¸ Rain: 0.2mm | ğŸ’¨ Wind: 5.4km/h | ğŸ§­ Direction: 180Â° | ğŸ’¨ Gust: 8.1km/h | â²ï¸ Pressure: 1020.5hPa | â˜€ï¸ Radiation: 45W/mÂ²</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 2: FORNELLS - ÃšLTIM PERÃODE (BILINGÃœE) ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸŒ¤ï¸ Fornells de la Selva | PerÃ­ode: '"$PERIOD"' | ğŸŒ¡ï¸ Temp. Mitjana: 8.2Â°C | ğŸ”¥ Temp. MÃ xima: 8.9Â°C | â„ï¸ Temp. MÃ­nima: 7.5Â°C | ğŸ’§ Humitat: 94% | ğŸŒ§ï¸ Pluja: 0.3mm | ğŸ’¨ Vent: 4.8km/h | ğŸ§­ DirecciÃ³: 195Â° | ğŸ’¨ RÃ fega: 7.5km/h | â²ï¸ PressiÃ³: 1020.2hPa | â˜€ï¸ RadiaciÃ³: 42W/mÂ² || ğŸŒ¤ï¸ Fornells de la Selva | Period: '"$PERIOD"' | ğŸŒ¡ï¸ Avg Temp: 8.2Â°C | ğŸ”¥ Max Temp: 8.9Â°C | â„ï¸ Min Temp: 7.5Â°C | ğŸ’§ Humidity: 94% | ğŸŒ§ï¸ Rain: 0.3mm | ğŸ’¨ Wind: 4.8km/h | ğŸ§­ Direction: 195Â° | ğŸ’¨ Gust: 7.5km/h | â²ï¸ Pressure: 1020.2hPa | â˜€ï¸ Radiation: 42W/mÂ²</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 3: GIRONA - RESUM DEL DIA (BILINGÃœE) ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸ“Š RESUM DEL DIA Girona | Data: '"$DATE_DDMM"' | PerÃ­ode: 00:00-'"$PERIOD_END"' | ğŸ”¥ Temperatura MÃ xima: 10.8Â°C | â„ï¸ Temperatura MÃ­nima: 6.2Â°C | ğŸŒ§ï¸ Pluja Acumulada: 2.8mm || ğŸ“Š TODAY'"'"'S SUMMARY Girona | Date: '"$DATE_YYYYMM"' | Period: 00:00-'"$PERIOD_END"' | ğŸ”¥ Maximum Temperature: 10.8Â°C | â„ï¸ Minimum Temperature: 6.2Â°C | ğŸŒ§ï¸ Accumulated Rain: 2.8mm</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 4: FORNELLS - RESUM DEL DIA (BILINGÃœE) ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸ“Š RESUM DEL DIA Fornells de la Selva | Data: '"$DATE_DDMM"' | PerÃ­ode: 00:00-'"$PERIOD_END"' | ğŸ”¥ Temperatura MÃ xima: 10.5Â°C | â„ï¸ Temperatura MÃ­nima: 5.8Â°C | ğŸŒ§ï¸ Pluja Acumulada: 3.2mm || ğŸ“Š TODAY'"'"'S SUMMARY Fornells de la Selva | Date: '"$DATE_YYYYMM"' | Period: 00:00-'"$PERIOD_END"' | ğŸ”¥ Maximum Temperature: 10.5Â°C | â„ï¸ Minimum Temperature: 5.8Â°C | ğŸŒ§ï¸ Accumulated Rain: 3.2mm</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          echo '</channel>' >> meteo.rss
          echo '</rss>' >> meteo.rss
          
          echo "âœ… RSS generat amb descripcions llegibles"
          echo "ğŸ“Š 4 Ã­tems bilingÃ¼es"
          echo "ğŸ”¤ Descripcions: TMâ†’ğŸŒ¡ï¸ Temp. Mitjana, TXâ†’ğŸ”¥ Temp. MÃ xima, etc."
      
      - name: Copy HTML to gh-pages
        run: |
          echo "ğŸ“„ Creant HTML actualitzat..."
          cat > index.html << 'HTML'
<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker MeteorolÃ²gic OBS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: transparent; font-family: Arial, sans-serif; overflow: hidden; height: 85px; display: flex; align-items: center; }
        .ticker-container { width: 100%; height: 70px; background: #000; color: #fff; display: flex; align-items: center; position: relative; overflow: hidden; margin: 7px 0; }
        .legend { background: #000; color: #fff; padding: 0 25px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; white-space: nowrap; position: absolute; left: 0; z-index: 10; border-right: 3px solid #ffcc00; }
        .ticker-content { display: flex; align-items: center; position: absolute; left: 100%; white-space: nowrap; animation: none; }
        .weather-block { display: flex; align-items: center; margin-right: 40px; font-size: 22px; font-family: Arial, sans-serif; }
        .separator { margin: 0 25px; color: #ffcc00; font-weight: bold; font-size: 22px; font-family: Arial, sans-serif; }
        .city-name { color: #4CAF50; font-weight: bold; }
        .temp-max { color: #ff6b6b; font-weight: bold; }
        .temp-min { color: #6bc5ff; font-weight: bold; }
        .temp-avg { color: #ffcc00; font-weight: bold; }
        .rain-amount { color: #66ccff; font-weight: bold; }
        .daily-max { color: #ff9966; font-weight: bold; }
        .daily-min { color: #66ccff; font-weight: bold; }
        @keyframes ticker-scroll-right-to-left {
            0% { transform: translateX(0); left: 100%; }
            100% { transform: translateX(-100%); left: 0%; }
        }
        .loading { color: #ccc; font-style: italic; font-size: 22px; }
    </style>
</head>
<body>
    <div class="ticker-container">
        <div class="legend">GIRONÃˆS-TEMPS ACTUAL- FONT: METEO.CAT</div>
        <div class="ticker-content" id="tickerContent">
            <div class="loading">Carregant dades meteorolÃ²giques...</div>
        </div>
    </div>
    <script>
        const RSS_URL = 'meteo.rss';
        console.log("ğŸš€ Iniciant ticker...");
        
        function startControlledAnimation(contentElement) {
            const contentWidth = contentElement.scrollWidth;
            const container = document.querySelector('.ticker-container');
            const legendWidth = 350;
            const visibleWidth = container.offsetWidth - legendWidth;
            const totalDistance = contentWidth + visibleWidth;
            const pixelsPerSecond = 60;
            const durationSeconds = totalDistance / pixelsPerSecond;
            
            console.log(`ğŸ“ AnimaciÃ³: ${durationSeconds.toFixed(1)}s`);
            
            contentElement.style.animation = 'none';
            void contentElement.offsetWidth;
            contentElement.style.animation = `ticker-scroll-right-to-left ${durationSeconds}s linear`;
            return durationSeconds;
        }
        
        function setupAnimationEndListener(contentElement, callback) {
            const onAnimationEnd = () => {
                contentElement.removeEventListener('animationend', onAnimationEnd);
                callback();
            };
            contentElement.addEventListener('animationend', onAnimationEnd);
        }
        
        async function fetchWeatherData() {
            try {
                console.log(`ğŸ” Recuperant dades...`);
                const response = await fetch(RSS_URL + '?t=' + new Date().getTime(), { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const rssText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rssText, "text/xml");
                const items = xmlDoc.getElementsByTagName('item');
                if (items.length === 0) throw new Error('No hi ha dades');
                
                processRSSData(items);
                console.log('âœ… Dades actualitzades');
            } catch (error) {
                console.error('âŒ Error:', error);
                showError();
            }
        }
        
        function processRSSData(items) {
            const tickerContent = document.getElementById('tickerContent');
            let allContent = '';
            
            for (let i = 0; i < items.length; i++) {
                const title = items[i].getElementsByTagName('title')[0]?.textContent || '';
                if (title) {
                    let processedTitle = title
                        .replace(/ğŸŒ¤ï¸ (Girona|Fornells de la Selva) \|/g, 'ğŸŒ¤ï¸ <span class="city-name">$1</span> |')
                        .replace(/ğŸ“Š RESUM DEL DIA (Girona|Fornells de la Selva) \|/g, 'ğŸ“Š RESUM DEL DIA <span class="city-name">$1</span> |')
                        .replace(/ğŸŒ¡ï¸ Temp\. Mitjana: (-?[0-9.]+)Â°C/g, 'ğŸŒ¡ï¸ Temp. Mitjana: <span class="temp-avg">$1Â°C</span>')
                        .replace(/ğŸ”¥ Temp\. MÃ xima: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Temp. MÃ xima: <span class="temp-max">$1Â°C</span>')
                        .replace(/â„ï¸ Temp\. MÃ­nima: (-?[0-9.]+)Â°C/g, 'â„ï¸ Temp. MÃ­nima: <span class="temp-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Pluja: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Pluja: <span class="rain-amount">$1mm</span>')
                        .replace(/ğŸ’¨ Vent: (-?[0-9.]+)km\/h/g, 'ğŸ’¨ Vent: <span class="temp-avg">$1km/h</span>')
                        .replace(/ğŸ’¨ RÃ fega: (-?[0-9.]+)km\/h/g, 'ğŸ’¨ RÃ fega: <span class="temp-max">$1km/h</span>')
                        .replace(/ğŸ”¥ Temperatura MÃ xima: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Temperatura MÃ xima: <span class="daily-max">$1Â°C</span>')
                        .replace(/â„ï¸ Temperatura MÃ­nima: (-?[0-9.]+)Â°C/g, 'â„ï¸ Temperatura MÃ­nima: <span class="daily-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Pluja Acumulada: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Pluja Acumulada: <span class="rain-amount">$1mm</span>')
                        .replace(/ğŸŒ¡ï¸ Avg Temp: (-?[0-9.]+)Â°C/g, 'ğŸŒ¡ï¸ Avg Temp: <span class="temp-avg">$1Â°C</span>')
                        .replace(/ğŸ”¥ Max Temp: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Max Temp: <span class="temp-max">$1Â°C</span>')
                        .replace(/â„ï¸ Min Temp: (-?[0-9.]+)Â°C/g, 'â„ï¸ Min Temp: <span class="temp-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Rain: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Rain: <span class="rain-amount">$1mm</span>')
                        .replace(/ğŸ’¨ Wind: (-?[0-9.]+)km\/h/g, 'ğŸ’¨ Wind: <span class="temp-avg">$1km/h</span>')
                        .replace(/ğŸ’¨ Gust: (-?[0-9.]+)km\/h/g, 'ğŸ’¨ Gust: <span class="temp-max">$1km/h</span>')
                        .replace(/ğŸ”¥ Maximum Temperature: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Maximum Temperature: <span class="daily-max">$1Â°C</span>')
                        .replace(/â„ï¸ Minimum Temperature: (-?[0-9.]+)Â°C/g, 'â„ï¸ Minimum Temperature: <span class="daily-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Accumulated Rain: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Accumulated Rain: <span class="rain-amount">$1mm</span>')
                        .trim();
                    
                    allContent += `<div class="weather-block">${processedTitle}</div>`;
                    if (i < items.length - 1) allContent += '<div class="separator">||</div>';
                }
            }
            
            const finalContent = allContent + '<div class="separator">||</div>' + allContent;
            tickerContent.innerHTML = finalContent;
            const duration = startControlledAnimation(tickerContent);
            console.log(`ğŸŒ€ ${items.length} Ã­tems, AnimaciÃ³: ${duration.toFixed(1)}s`);
        }
        
        function showError() {
            document.getElementById('tickerContent').innerHTML = 
                '<div class="loading">Error carregant dades. Tornant a intentar...</div>';
            setTimeout(fetchWeatherData, 5000);
        }
        
        async function initTicker() {
            try {
                console.log("ğŸš€ Iniciant ticker...");
                await fetchWeatherData();
                const tickerContent = document.getElementById('tickerContent');
                setupAnimationEndListener(tickerContent, () => {
                    console.log("ğŸ”„ AnimaciÃ³ acabada, actualitzant...");
                    setTimeout(fetchWeatherData, 1000);
                });
            } catch (error) {
                console.error('âŒ Error inicial:', error);
                setTimeout(initTicker, 10000);
            }
        }
        
        document.addEventListener('DOMContentLoaded', initTicker);
        setInterval(() => {
            console.log('ğŸ”„ ActualitzaciÃ³ programada');
            fetchWeatherData();
        }, 300000);
    </script>
</body>
</html>
HTML
          
          echo "âœ… HTML creat"
      
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          commit_message: "ğŸ“¡ Update RSS i HTML - $(date +'%H:%M') - PerÃ­ode: $PERIOD"
      
      - name: Show URLs
        run: |
          echo "ğŸ‰ DESPLEGAMENT COMPLETAT"
          echo "=========================="
          echo "ğŸŒ PÃ gina web: https://joandecorts.github.io/meteo-rss-auto/"
          echo "ğŸ“„ RSS feed: https://joandecorts.github.io/meteo-rss-auto/meteo.rss"
          echo "ğŸ“… Data: $(date)"
          echo "ğŸ•’ Hora: $(date +%H:%M:%S)"
          echo "=========================="
