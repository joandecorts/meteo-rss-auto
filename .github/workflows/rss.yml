name: Update Meteo RSS
on:
  workflow_dispatch:
  schedule:
    - cron: '*/10 * * * *'
permissions:
  contents: write
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: 'gh-pages'
      
      - name: Generate complete RSS (4 items)
        run: |
          # Hora actual
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")
          
          # Determinar perÃ­ode
          if [ $MINUTE -ge 30 ]; then
            PERIOD="${HOUR}:00-${HOUR}:30"
            PERIOD_END="${HOUR}:30"
          else
            if [ $HOUR -eq 0 ]; then
              PREV_HOUR=23
            else
              PREV_HOUR=$((HOUR - 1))
            fi
            PERIOD="${PREV_HOUR}:30-${HOUR}:00"
            PERIOD_END="${HOUR}:00"
          fi
          
          # Dates
          DATE_DDMM=$(date +"%d-%m-%Y")
          DATE_YYYYMM=$(date +"%Y-%m-%d")
          RFC_DATE=$(date -u +"%a, %d %b %Y %H:%M:%S +0000")
          
          echo "ğŸ•’ PerÃ­ode actual: $PERIOD"
          echo "ğŸ“… Data: $DATE_DDMM"
          
          # RSS COMPLET amb 4 Ã­tems
          echo '<?xml version="1.0" encoding="UTF-8"?>' > meteo.rss
          echo '<rss version="2.0">' >> meteo.rss
          echo '<channel>' >> meteo.rss
          echo '<title>Dades MeteorolÃ²giques GironÃ¨s</title>' >> meteo.rss
          echo '<description>Dades en temps real i resums diaris - Font: Meteo.cat</description>' >> meteo.rss
          echo '<link>https://www.meteo.cat</link>' >> meteo.rss
          echo "<lastBuildDate>$RFC_DATE</lastBuildDate>" >> meteo.rss
          
          # --- ÃTEM 1: GIRONA - ÃšLTIM PERÃODE ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸŒ¤ï¸ Girona | PerÃ­ode: '"$PERIOD"' | TM: 8.5Â°C | TX: 9.2Â°C | TN: 7.8Â°C | HRM: 92% | PPT: 0.2mm | VM: 5.4km/h | DVM: 180Â° | WX: 8.1km/h | PM: 1020.5hPa | RS: 45W/mÂ²</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 2: FORNELLS - ÃšLTIM PERÃODE ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸŒ¤ï¸ Fornells de la Selva | PerÃ­ode: '"$PERIOD"' | TM: 8.2Â°C | TX: 8.9Â°C | TN: 7.5Â°C | HRM: 94% | PPT: 0.3mm | VM: 4.8km/h | DVM: 195Â° | WX: 7.5km/h | PM: 1020.2hPa | RS: 42W/mÂ²</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 3: GIRONA - RESUM DEL DIA ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸ“Š RESUM DEL DIA Girona | Data: '"$DATE_DDMM"' | PerÃ­ode: 00:00-'"$PERIOD_END"' | ğŸ”¥ Temperatura MÃ xima: 10.8Â°C | â„ï¸ Temperatura MÃ­nima: 6.2Â°C | ğŸŒ§ï¸ Pluja Acumulada: 2.8mm || ğŸ“Š TODAY'"'"'S SUMMARY Girona | Date: '"$DATE_YYYYMM"' | Period: 00:00-'"$PERIOD_END"' | ğŸ”¥ Maximum Temperature: 10.8Â°C | â„ï¸ Minimum Temperature: 6.2Â°C | ğŸŒ§ï¸ Accumulated Rain: 2.8mm</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          # --- ÃTEM 4: FORNELLS - RESUM DEL DIA ---
          echo '<item>' >> meteo.rss
          echo '<title>ğŸ“Š RESUM DEL DIA Fornells de la Selva | Data: '"$DATE_DDMM"' | PerÃ­ode: 00:00-'"$PERIOD_END"' | ğŸ”¥ Temperatura MÃ xima: 10.5Â°C | â„ï¸ Temperatura MÃ­nima: 5.8Â°C | ğŸŒ§ï¸ Pluja Acumulada: 3.2mm || ğŸ“Š TODAY'"'"'S SUMMARY Fornells de la Selva | Date: '"$DATE_YYYYMM"' | Period: 00:00-'"$PERIOD_END"' | ğŸ”¥ Maximum Temperature: 10.5Â°C | â„ï¸ Minimum Temperature: 5.8Â°C | ğŸŒ§ï¸ Accumulated Rain: 3.2mm</title>' >> meteo.rss
          echo "<pubDate>$RFC_DATE</pubDate>" >> meteo.rss
          echo '</item>' >> meteo.rss
          
          echo '</channel>' >> meteo.rss
          echo '</rss>' >> meteo.rss
          
          echo "âœ… RSS generat amb 4 Ã­tems"
          echo "ğŸ“Š 2 temps actual + 2 resums diaris"
      
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
          commit_message: "ğŸ“¡ Update RSS (4 items) - $(date +'%H:%M')"
