<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticker MeteorolÃ²gic OBS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: transparent;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 85px;
            display: flex;
            align-items: center;
        }
        
        .ticker-container {
            width: 100%;
            height: 70px;
            background: #000;
            color: #fff;
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
            margin: 7px 0;
        }
        
        .legend {
            background: #000;
            color: #fff;
            padding: 0 25px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            white-space: nowrap;
            position: absolute;
            left: 0;
            z-index: 10;
            border-right: 3px solid #ffcc00;
        }
        
        .ticker-content {
            display: flex;
            align-items: center;
            position: absolute;
            left: 100%; /* COMENÃ‡A FORA PER LA DRETA */
            white-space: nowrap;
            animation: none; /* Controlat per JavaScript */
        }
        
        .weather-block {
            display: flex;
            align-items: center;
            margin-right: 40px;
            font-size: 22px;
            font-family: 'Arial', sans-serif;
        }
        
        .separator {
            margin: 0 25px;
            color: #ffcc00;
            font-weight: bold;
            font-size: 22px;
            font-family: 'Arial', sans-serif;
        }
        
        .city-name {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .temp-max {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .temp-min {
            color: #6bc5ff;
            font-weight: bold;
        }
        
        .temp-avg {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .temp-current {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .rain-amount {
            color: #66ccff;
            font-weight: bold;
        }
        
        .daily-max {
            color: #ff9966;
            font-weight: bold;
        }
        
        .daily-min {
            color: #66ccff;
            font-weight: bold;
        }
        
        /* ANIMACIÃ“ CORREGIDA: De dreta a esquerra */
        @keyframes ticker-scroll-right-to-left {
            0% {
                transform: translateX(0);
                left: 100%;
            }
            100% {
                transform: translateX(-100%);
                left: 0%;
            }
        }

        .loading {
            color: #cccccc;
            font-style: italic;
            font-size: 22px;
        }
    </style>
</head>
<body>
    <div class="ticker-container">
        <div class="legend">GIRONÃˆS-TEMPS ACTUAL- FONT: METEO.CAT</div>
        <div class="ticker-content" id="tickerContent">
            <div class="loading">Carregant dades meteorolÃ²giques...</div>
        </div>
    </div>

    <script>
        // URL del RSS a gh-pages (MATEIX DOMINI - NO CORS!)
        const RSS_URL = 'meteo.rss';  // â† RELATIVA perquÃ¨ estan al mateix lloc!
        
        console.log("ğŸš€ Iniciant ticker... URL RSS:", RSS_URL);

        // FUNCIÃ“ PER CALCULAR I INICIAR L'ANIMACIÃ“ EXACTA
        function startControlledAnimation(contentElement) {
            // 1. Calcular l'amplada total del contingut
            const contentWidth = contentElement.scrollWidth;
            
            // 2. Calcular l'amplada visible (contenidor - llegenda)
            const container = document.querySelector('.ticker-container');
            const legendWidth = 350; // Amplada de la llegenda
            const visibleWidth = container.offsetWidth - legendWidth;
            
            // 3. DISTÃ€NCIA TOTAL A RECÃ“RRER:
            const totalDistance = contentWidth + visibleWidth;
            
            // 4. VELOCITAT DESITJADA (pÃ­xels per segon)
            const pixelsPerSecond = 60;
            
            // 5. CALCULAR DURACIÃ“ EXACTA
            const durationSeconds = totalDistance / pixelsPerSecond;
            
            console.log(`ğŸ“ AnimaciÃ³: ${durationSeconds.toFixed(1)}s, DistÃ ncia: ${totalDistance}px`);
            
            // 6. APLICAR L'ANIMACIÃ“
            contentElement.style.animation = 'none';
            void contentElement.offsetWidth; // ForÃ§ar reflow
            
            contentElement.style.animation = `ticker-scroll-right-to-left ${durationSeconds}s linear`;
            
            return durationSeconds;
        }

        // FUNCIÃ“ PER REINICIAR L'ANIMACIÃ“ (quan acaba)
        function setupAnimationEndListener(contentElement, callback) {
            const onAnimationEnd = () => {
                contentElement.removeEventListener('animationend', onAnimationEnd);
                callback();
            };
            contentElement.addEventListener('animationend', onAnimationEnd);
        }

        // FUNCIÃ“ PER OBTENIR DADES RSS
        async function fetchWeatherData() {
            try {
                console.log(`ğŸ” Recuperant dades de: ${RSS_URL}`);
                
                // FETCH SIMPLE - mateix domini, no CORS
                const response = await fetch(RSS_URL + '?t=' + new Date().getTime(), {
                    cache: 'no-store'
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const rssText = await response.text();
                
                console.log("âœ… Dades rebudes, processant...");
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(rssText, "text/xml");
                const items = xmlDoc.getElementsByTagName('item');
                
                if (items.length === 0) throw new Error('No hi ha dades al RSS');
                
                processRSSData(items);
                console.log('âœ… Dades actualitzades correctament');
                
            } catch (error) {
                console.error('âŒ Error recuperant dades:', error);
                showError();
            }
        }

        // PROCESSAR DADES RSS
        function processRSSData(items) {
            const tickerContent = document.getElementById('tickerContent');
            let allContent = '';
            
            for (let i = 0; i < items.length; i++) {
                const title = items[i].getElementsByTagName('title')[0]?.textContent || '';
                
                if (title) {
                    let processedTitle = title
                        // Ciutat
                        .replace(/ğŸŒ¤ï¸ (Girona|Fornells de la Selva) \|/g, 'ğŸŒ¤ï¸ <span class="city-name">$1</span> |')
                        .replace(/ğŸ“Š RESUM DEL DIA (Girona|Fornells de la Selva) \|/g, 'ğŸ“Š RESUM DEL DIA <span class="city-name">$1</span> |')
                        
                        // Temps actual - ParÃ metres
                        .replace(/TM: (-?[0-9.]+)Â°C/g, 'TM: <span class="temp-avg">$1Â°C</span>')
                        .replace(/TX: (-?[0-9.]+)Â°C/g, 'TX: <span class="temp-max">$1Â°C</span>')
                        .replace(/TN: (-?[0-9.]+)Â°C/g, 'TN: <span class="temp-min">$1Â°C</span>')
                        .replace(/PPT: (-?[0-9.]+)mm/g, 'PPT: <span class="rain-amount">$1mm</span>')
                        .replace(/VM: (-?[0-9.]+)km\/h/g, 'VM: <span class="temp-avg">$1km/h</span>')
                        .replace(/WX: (-?[0-9.]+)km\/h/g, 'WX: <span class="temp-max">$1km/h</span>')
                        .replace(/DVM: (-?[0-9.]+)Â°/g, 'DVM: <span class="temp-avg">$1Â°</span>')
                        .replace(/PM: (-?[0-9.]+)hPa/g, 'PM: <span class="temp-avg">$1hPa</span>')
                        .replace(/HRM: (-?[0-9.]+)%/g, 'HRM: <span class="temp-avg">$1%</span>')
                        .replace(/RS: (-?[0-9.]+)W\/mÂ²/g, 'RS: <span class="temp-avg">$1W/mÂ²</span>')
                        
                        // Resum diari
                        .replace(/ğŸ”¥ Temperatura MÃ xima: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Temperatura MÃ xima: <span class="daily-max">$1Â°C</span>')
                        .replace(/â„ï¸ Temperatura MÃ­nima: (-?[0-9.]+)Â°C/g, 'â„ï¸ Temperatura MÃ­nima: <span class="daily-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Pluja Acumulada: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Pluja Acumulada: <span class="rain-amount">$1mm</span>')
                        
                        // VersiÃ³ anglesa
                        .replace(/ğŸ”¥ Maximum Temperature: (-?[0-9.]+)Â°C/g, 'ğŸ”¥ Maximum Temperature: <span class="daily-max">$1Â°C</span>')
                        .replace(/â„ï¸ Minimum Temperature: (-?[0-9.]+)Â°C/g, 'â„ï¸ Minimum Temperature: <span class="daily-min">$1Â°C</span>')
                        .replace(/ğŸŒ§ï¸ Accumulated Rain: (-?[0-9.]+)mm/g, 'ğŸŒ§ï¸ Accumulated Rain: <span class="rain-amount">$1mm</span>')
                        
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    allContent += `<div class="weather-block">${processedTitle}</div>`;
                    if (i < items.length - 1) allContent += '<div class="separator">||</div>';
                }
            }
            
            // DUPLIQUEM per transiciÃ³ contÃ­nua
            const finalContent = allContent + '<div class="separator">||</div>' + allContent;
            tickerContent.innerHTML = finalContent;
            
            // INICIAR ANIMACIÃ“
            const duration = startControlledAnimation(tickerContent);
            console.log(`ğŸŒ€ ${items.length} Ã­tems, AnimaciÃ³: ${duration.toFixed(1)}s`);
        }

        function showError() {
            document.getElementById('tickerContent').innerHTML = 
                '<div class="loading">Error carregant dades. Tornant a intentar...</div>';
            setTimeout(fetchWeatherData, 5000);
        }

        // DADES DE FALLBACK (per si falla)
        function loadFallbackData() {
            console.log("âš ï¸ Carregant dades de fallback");
            const fallbackContent = `
                <div class="weather-block">ğŸŒ¤ï¸ <span class="city-name">Girona</span> | PerÃ­ode: 07:00-07:30 | TM: <span class="temp-avg">8.5Â°C</span> | TX: <span class="temp-max">9.2Â°C</span> | TN: <span class="temp-min">7.8Â°C</span></div>
                <div class="separator">||</div>
                <div class="weather-block">ğŸŒ¤ï¸ <span class="city-name">Fornells</span> | PerÃ­ode: 07:00-07:30 | TM: <span class="temp-avg">8.2Â°C</span> | TX: <span class="temp-max">8.9Â°C</span> | TN: <span class="temp-min">7.5Â°C</span></div>
                <div class="separator">||</div>
                <div class="weather-block">ğŸ“Š <span class="city-name">Girona</span> | Data: 16-12-2025 | ğŸ”¥ Temperatura MÃ xima: <span class="daily-max">10.8Â°C</span> | â„ï¸ Temperatura MÃ­nima: <span class="daily-min">6.2Â°C</span></div>
                <div class="separator">||</div>
                <div class="weather-block">ğŸ“Š <span class="city-name">Fornells</span> | Data: 16-12-2025 | ğŸ”¥ Temperatura MÃ xima: <span class="daily-max">10.5Â°C</span> | â„ï¸ Temperatura MÃ­nima: <span class="daily-min">5.8Â°C</span></div>
            `;
            const duplicatedContent = fallbackContent + '<div class="separator">||</div>' + fallbackContent;
            const tickerContent = document.getElementById('tickerContent');
            tickerContent.innerHTML = duplicatedContent;
            startControlledAnimation(tickerContent);
        }

        // INICIALITZACIÃ“
        async function initTicker() {
            try {
                console.log("ğŸš€ Iniciant ticker meteorolÃ²gic...");
                await fetchWeatherData();
                
                // Programar actualitzaciÃ³ quan acabi l'animaciÃ³
                const tickerContent = document.getElementById('tickerContent');
                setupAnimationEndListener(tickerContent, () => {
                    console.log("ğŸ”„ AnimaciÃ³ acabada, actualitzant...");
                    setTimeout(fetchWeatherData, 1000);
                });
                
            } catch (error) {
                console.error('âŒ Error inicial:', error);
                loadFallbackData();
                setTimeout(initTicker, 10000);
            }
        }

        // INICIAR QUAN ES CARREGA LA PÃ€GINA
        document.addEventListener('DOMContentLoaded', initTicker);

        // ACTUALITZACIÃ“ CADA 5 MINUTS
        setInterval(() => {
            console.log('ğŸ”„ ActualitzaciÃ³ programada');
            fetchWeatherData();
        }, 300000);

    </script>
</body>
</html>
